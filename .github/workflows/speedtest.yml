name: Auto Cloudflare SpeedTest (Telecom Optimized)

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ä¸­åˆ 12:00 è¿è¡Œ (UTCæ—¶é—´ 4:00)
    # ä½ å¯ä»¥æ ¹æ®éœ€è¦ä¿®æ”¹ï¼Œæ¯”å¦‚ '0 21 * * *' æ˜¯åŒ—äº¬æ—¶é—´å‡Œæ™¨5ç‚¹
    - cron: '0 4 * * *'
  workflow_dispatch:      # å…è®¸ä½ åœ¨ Actions é¡µé¢æ‰‹åŠ¨ç‚¹å‡»æŒ‰é’®ç«‹å³è¿è¡Œ

jobs:
  update-dns:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Fetch Best IP
        run: |
          # ---------------------------------------------------------------------
          # æ ¸å¿ƒæ­¥éª¤ï¼šè·å–ä¼˜é€‰ IP
          # ä½¿ç”¨ ymyuuu/IPDB çš„ bestproxy.txtï¼Œè¿™æ˜¯ä¸€ä¸ªç»´æŠ¤å¾ˆå‹¤å¿«çš„é«˜è´¨é‡ IP åˆ—è¡¨
          # ---------------------------------------------------------------------
          IP_LIST_URL="https://raw.githubusercontent.com/ymyuuu/IPDB/main/bestproxy.txt"
          
          echo "æ­£åœ¨ä» $IP_LIST_URL ä¸‹è½½ IP åˆ—è¡¨..."
          wget -q -O all_ips.txt $IP_LIST_URL
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸‹è½½æˆåŠŸä¸”ä¸ä¸ºç©º
          if [ ! -s all_ips.txt ]; then
            echo "Error: ä¸‹è½½ IP åˆ—è¡¨å¤±è´¥æˆ–æ–‡ä»¶ä¸ºç©º"
            exit 1
          fi

          # ---------------------------------------------------------------------
          # æå–é€»è¾‘ï¼š
          # 1. grep: ç¡®ä¿åªæå– IPv4 åœ°å€ (æ’é™¤ IPv6 æˆ–å¹²æ‰°è¡Œ)
          # 2. head -n 20: å–åˆ—è¡¨é‡Œæµ‹é€Ÿæœ€å¿«çš„å‰ 20 ä¸ª IP
          # 3. shuf -n 1:  ä»ä¸­éšæœºé€‰ 1 ä¸ª (é¿å…æ­»ç›¯ç€ç¬¬1åè–…ï¼Œé˜²æ­¢è¢«å°)
          # 4. cut -d: -f1: å»æ‰ç«¯å£å· (ä¾‹å¦‚ 1.2.3.4:443 -> 1.2.3.4)
          # ---------------------------------------------------------------------
          BEST_IP=$(grep -E '^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+' all_ips.txt | head -n 20 | shuf -n 1 | cut -d: -f1)
          
          if [ -z "$BEST_IP" ]; then
             echo "Error: æœªèƒ½æå–åˆ°æœ‰æ•ˆ IPï¼Œè¯·æ£€æŸ¥åˆ—è¡¨æº"
             exit 1
          fi
          
          echo "ğŸ‰ æˆåŠŸé€‰å®šä¼˜é€‰ IP: $BEST_IP"
          # å°†ç»“æœå†™å…¥ç¯å¢ƒå˜é‡ï¼Œä¾›ä¸‹ä¸€æ­¥éª¤ä½¿ç”¨
          echo "BEST_IP=$BEST_IP" >> $GITHUB_ENV

      - name: Update DNS Record
        env:
          # è¿™é‡Œçš„ secrets å¿…é¡»å’Œä½ åœ¨ GitHub Settings é‡Œè®¾ç½®çš„å˜é‡åä¿æŒä¸€è‡´
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CF_ZONE_ID: ${{ secrets.CF_ZONE_ID }}
          CF_DNS_NAME: ${{ secrets.CF_DNS_NAME }}
        run: |
          # ---------------------------------------------------------------------
          # è°ƒç”¨ Cloudflare API æ›´æ–°åŸŸåè§£æ
          # ---------------------------------------------------------------------
          
          # 1. è·å–åŸŸåå½“å‰çš„ DNS è®°å½• ID
          RECORD_INFO=$(curl -s -X GET "https://api.cloudflare.com/client/v4/zones/$CF_ZONE_ID/dns_records?name=$CF_DNS_NAME" \
            -H "Authorization: Bearer $CF_API_TOKEN" \
            -H "Content-Type: application/json")
          
          # æå– ID
          RECORD_ID=$(echo $RECORD_INFO | jq -r '.result[0].id')
          
          # å¦‚æœæ‰¾ä¸åˆ°è®°å½•ï¼Œæç¤ºé”™è¯¯å¹¶åœæ­¢
          if [ "$RECORD_ID" == "null" ] || [ -z "$RECORD_ID" ]; then
            echo "âŒ Error: æ‰¾ä¸åˆ°åŸŸåçš„è®°å½• IDã€‚"
            echo "è¯·å…ˆåœ¨ Cloudflare æ§åˆ¶å°æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ª A è®°å½• (ä¾‹å¦‚: best.ä½ çš„åŸŸå.com æŒ‡å‘ 1.1.1.1)ï¼Œç„¶åå†è¿è¡Œæ­¤è„šæœ¬ã€‚"
            exit 1
          fi

          # 2. æ›´æ–° IP åœ°å€
          echo "æ­£åœ¨æ›´æ–° DNS è®°å½•: $CF_DNS_NAME -> $BEST_IP ..."
          
          UPDATE_RESULT=$(curl -s -X PUT "https://api.cloudflare.com/client/v4/zones/$CF_ZONE_ID/dns_records/$RECORD_ID" \
            -H "Authorization: Bearer $CF_API_TOKEN" \
            -H "Content-Type: application/json" \
            --data "{\"type\":\"A\",\"name\":\"$CF_DNS_NAME\",\"content\":\"$BEST_IP\",\"ttl\":60,\"proxied\":false}")
          
          # æ£€æŸ¥æ›´æ–°ç»“æœ
          SUCCESS=$(echo $UPDATE_RESULT | jq -r '.success')
          
          if [ "$SUCCESS" == "true" ]; then
            echo "âœ… æ›´æ–°æˆåŠŸï¼å½“å‰åŸŸåå·²æŒ‡å‘: $BEST_IP"
          else
            echo "âŒ æ›´æ–°å¤±è´¥ï¼ŒCloudflare è¿”å›ä¿¡æ¯å¦‚ä¸‹ï¼š"
            echo $UPDATE_RESULT
            exit 1
          fi
